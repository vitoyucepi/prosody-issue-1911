name: Test
on:
  push:
  workflow_dispatch:

jobs:
  prosody-0_12:
      name: Test prosody 0.12
      runs-on: ubuntu-24.04
      steps:
        - uses: actions/checkout@v4.2.2
        - uses: hoverkraft-tech/compose-action@v2.2.0
          with:
            compose-file: "./compose.yaml"
          env:
            PROSODY_VERSION: "0.12"
        - name: Test
          run: |
            openssl s_client -connect 127.0.0.1:5222 -starttls xmpp -xmpphost prosody.test -showcerts < /dev/null | grep subject
            openssl s_client -connect 127.0.0.1:5223 -servername prosody.test -showcerts < /dev/null
            openssl s_client -connect 127.0.0.1:5269 -starttls xmpp-server -xmpphost prosody.test -showcerts < /dev/null
            openssl s_client -connect 127.0.0.1:5270 -servername prosody.test -showcerts < /dev/null
            openssl s_client -connect 127.0.0.1:5281 -servername prosody.test -showcerts < /dev/null
